#!/bin/bash

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )

user=vagrant
mastermachine=localhost
outputdir=/home/vagrant/test-results
port=8888
thismachine=$(hostname)

while true;
do
  unittest=$(beanstalkd-cli --server $mastermachine --port $port pop --tube testing)
  
  if [ -z "$unittest" ]; then
    sleep 1
    echo "Waiting for tests"
    continue
  fi

  start=`date +%s`

  killall java
  echo "Running $unittest"
  $DIR/run-unit-test $unittest
  retval=$?
  echo "Finished $unittest"

  end=`date +%s`
  runtime=$((end-start))
  timestamp=$(date)

  ssh $user@$mastermachine "mkdir -p $outputdir"

  if [ "$retval" -eq 0 ]; then
      echo "Test Passed"
      ssh $user@$mastermachine "echo -e 'Pass\tRanOn: $thismachine\t$TS: $timestamp\tDuration: $runtime sec\t\t$unittest' >> $outputdir/results.txt"
  else
      echo "Test Failed"
      pushd .
      cd ~/code/hops/hops
      TestNameSimple=`echo $unittest | sed 's/.java//g'`
      FullPath=`find . -iname "*$TestNameSimple-output.txt"`
      if [ -n "$FullPath" ]; then
        ssh $user@$mastermachine "echo -e 'FAIL\tRanOn: $thismachine\t$TS: $timestamp\tDuration: $runtime sec\t\t$unittest' >> $outputdir/results.txt"
        scp $FullPath "$user@$mastermachine:$outputdir/$unittest.txt"
      fi
      popd
  fi
done 

exit 0


